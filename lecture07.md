
# 第7回講義でセキュリテイについて学んだこと

## 想定されるリスク

データの盗難、改ざん、破壊

## 要因

| 要因 | 説明 |
| - | - |
| 脆弱性 | バグや設定不備によるシステムの弱点、穴。 |
| 認証情報の流出 | IAMアクセスキーなどが、誤ってGitHubなどの公開の場にアップロードされ、情報が流出 |
| 人為的な過負荷 | 多数のコンピュータから連続でリクエストを送り、停止に追いやる。<br>自分や他のユーザーのサービス品質が低下させ、高いリソースコストを発生させる。<br>DDoS攻撃など。 |　　

## 対応方針(アクション)４つ

| アクション | 説明 | 例 |
| - | - | - |
| 受容 | 何も対策をせず、そのまま受け入れる | 発生した頻度や影響を鑑みても、そのままでいいと判断した場合など |
| 低減 | 影響を減らすような対策を行う | 機密データを分散し、流出の被害の範囲を減らすなど |
| 転嫁 | リスク管理を当事者以外に任せる | AWSでのシステム構築する場合、データセンターへの侵入についての責任はAWS側で責任を持つなど |
| 回避 | リスク自体発生させないようにする | IAMのアクセスキー自体発行しないなど |

## AWSサービスのセキュリティ対策  

### 脆弱性

* アプリケーション


    | サービス | 説明 |
    | - | - |
    | Dependabot | GitHubでコードを管理している場合、モジュール・ライブラリの更新を指摘してくれるBot。 |
    | CodeGuru Reviewer | AIを用いてGitHubなどのリポジトリ内のコードをスキャンし、改善提案をしてくれる。料金が10万行コード毎に10ドルかかる。 |
    | Amazon WAF | Web Application Firewall。<br>OWASP Top 10がサポートされている。ELBやCloudFrontに設置することでWAFが評価してくれる。<br>※全ての攻撃を遮断してくれるわけではない為アプリケーションコード側で実施できる防護策は実施しておくことが必要。 |
    | ACM | AWS Certificate Manager。SSL証明書を発行するマネージドサービス。<br>ELBやCloudFrontにアタッチし、利用者とAWSサービス間の通信を暗号化し、覗き見を防ぐことができる。<br>パブリック証明書は無料で発行。<br>プライベート領収書は料金がかかる。<br>※ACMで発行した証明書は、HTTPS通信を経由する設定が必要。<br>ALBならリスナールールでHTTP をHTTPSに転送するルールを作る、CloudFrontならビューワープロトコルポリシーでHTTPS限定にするなど。 |


* OS、ミドルウェア  

    | サービス | 説明 |
    | - | - |
    | Amazon Inspector | 脆弱性のスキャンを行うサービス。<br>EC2とコンテナイメージ向けのECRのスキャンに対応。<br>脆弱性の情報源はNVDを元にしている。SSM Patch Managerというパッチ自動化支援もある |

* その他　　

    | サービス | 説明 |
    | - | - |
    | Security Hub | AWSの設定情報を検索して、脆弱な部分を指摘してくれたり、特定の業界基準に準拠しているかを確認してくれる。 |


### 認証情報の流出  
  
    

* よくあるものと対策

    | よくある事例 | 説明 | 対策 |
    | - | - | - |
    | IAM | IAMユーザーパスワードやIAMアクセスキー | ①MFAで本人のみログインする<br>②ロールで権限を管理。アクセスキーはReadOnlyにする |
    | アプリケーション | DBへの接続方法、管理者ページへのログイン情報 | 暗号化する。暗号化に使った「鍵」を保護。 |　　
  
　　

* IAMに集約できない認証情報の流出防止  

    KMS +Secrets Managerの組み合わせで保護  

    | サービス | 説明 |
    | - | - |
    | KMS | AWS Key Management Servise。<br>暗号鍵マネージドサービス。<br>①EBS、S3など透過的暗号化(データが自動的に暗号化・復号化する。)<br>②AWS CLIなどを用いた鍵の利用(ファイルや文字列を暗号化)。<br>KMS鍵自体がIAMポリシーとキーポリシー(キーに直接アタッチするポリシー)の２重で権限管理される為、鍵の利用権限がないと復号化ができない。 |
    | Secrets Manager | 秘匿しなければならない情報をKMSで暗号化して安全に保管、呼び出しするサービス。<br>開発キット(SDK)を使って、アプリケーションコードの取り出しの仕組みを実装。<br>RDSのみ、DBパスワードの定期変更ができる。 |                                                                                    |   

### 人為的な過負荷  

| サービス | 説明 |
| - | - |
| AWS Shield | DDoS攻撃と思われる通信を自動で遮断してくれる。<br>StandardとAdvancedがあり、前者は無料でAWSアカウントに適用されており、後者は月3000ドル(年間)と超高額。 |　　

### その他　　

| サービス | 説明 |
| - | - |
| IAM Access Analyzer | 各種のポリシーチェックを行い、大きな権限を与えていないか確認してくれるもの。<br>S3、IAMロール、KMS、Lambda、SQS、Secrets Manager |
| GuardDuty | AWS内のイベントをチェックし、セキュリティインシデントの疑いのあるイベントをAIが指摘してくれる。<br>アクセスキー流出、マイニングなど。 |
| Macie | S3バケットに個人情報やクレジットカード番号などが機密情報が含まれていないか検知する。 |
| Detective | 複数のAWSサービスを横断して、セキュリティインシデントの発生元などを特定するためのGUIを提供。 |
| Network Firewall | インターネットゲートウェイとVPCの境界に設置するファイヤーウォールを実現する。 |　　

# 感想　

* セキュリティ関連は、講義内で「後回しにされがち」という言葉があり、自身もセキュリティに関しては取っ付きにくさがあったので、必要に駆られたら実践するのかも...と思った。ただ、調べているうちに、大手の企業のセキュリティインシデントの記事を見つけた。パブリックのリポジトリに顧客情報のアクセスキーが5年間も公開されていた情報などのリアルな実例を知り、怖さを実感。調べるほどに奥が深く、並大抵でない知識量が必要だと感じた。  
* まだ現場で実務を行なってはいないため、実際にはピンと来ていない部分が多い。  
* 「この部分が漏洩につながるリスクになるかも」「この情報が取得されてしまうとこんな被害が出るかも」「この管理をきちんとしなければ、こんな影響が出るかも」等、想像力を働かせながら勉強していきたいと思った。  

# 課題：今作っている環境は、どんな攻撃に対して脆弱ですか？

## 脆弱性１ Http通信の覗き見

http通信のままなので、覗き見が可能な状態であること。  

### 対策  

ACMを使用し、ELBへアタッチし、通信をHTTPS化する。  
今回はELBにアタッチした場合の手順を調べてみました。  

#### ACMでSSL証明書を発行  

* ACM取得  
    1. AWSコンソール にログイン  
    2. 「ACM」 で検索し、「Certificate Manager」を開く  
  

* 証明書のリクエスト  
    1. 「パブリック証明書のリクエスト」を選択した状態で「証明書のリクエスト」をクリック   
    2. 取得したドメイン名を入力し「次へ」をクリック  
    3. 「DNS の検証」を選択し「次へ」 をクリック  
    4. 必要であればタグを追加  
    5. 「確認」をクリック  
    6. ドメインサービス側にCNAME レコードを登録  
    7. ACMの管理画面で「発行済み」になっていればOK  

* ELB にアタッチする
    1. ALBのリスナー設定で、HTTPSプロトコルと443ポート指定、作成していたセキュリティグループを設定  
    2. 「SSL証明書」欄に、「ACMから」を選択し、取得済みのSSL証明書を設定。  


## 脆弱性２ OWASP Top 10紹介されているような一般的なweb攻撃に対するリスク

サンプルアプリケーションの用途が、もし個人情報が集まるような用途で使用される場合、下記のような攻撃に対する注意が必要かと思った。
* SQLインジェクション、クロスサイトスクリプティングなどの攻撃
    * SQLインジェクション  
        | 攻撃名 | 内容 |
        | - | - |
        | SQLインジェクション | ユーザの入力値などを含んだSQL文を組み立てる処理に不備がある場合に、SQL(データベースのサーバーを操作する命令)文が書き換えられ意図していない処理を実行されてしまう脆弱性。<br>攻撃者は、情報窃取、データの改ざん、サービスの停止などを行うことが可能となる。 |

            被害実例
            クレジットカード決済システムへの被害で、データベースから数十万件のクレジットカード番号や有効期限、セキュリティーコードなどの流出。  

    * クロスサイトスクリプティング  
        | 攻撃名 | 内容 |
        | - | - |
        | クロスサイトスクリプティング | 攻撃者が送り込んだ悪意のコードをそのページを閲覧した不特定多数のユーザーに、スクリプト(簡易的なプログラム)として実行させる可能性があること。「XSS」などと省略されることもある。 |

### 対策  
WAFを導入。  
WAFでネットワーク通信を監視して、攻撃と判断した通信を遮断する。  
ECサイトのように、ユーザーの入力を受けたり、クレジットカード情報をはじめとする個人情報を取り扱ったりする動的サイトの保護に適したセキュリティ対策。
